<!-- 
Copy Code Button functionality
Adds copy buttons to all code blocks for better user experience
Features:
- Accessible copy buttons with ARIA labels
- Visual feedback on copy success
- Keyboard navigation support
- Responsive design
-->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Find all code blocks (both pre > code and .highlight pre)
  const codeBlocks = document.querySelectorAll('pre code, .highlight pre code, pre:not(.highlight)');
  
  codeBlocks.forEach(function(codeBlock) {
    // Skip if this code block already has a copy button
    if (codeBlock.parentElement.querySelector('.copy-code-button')) return;
    
    // Create the copy button
    const copyButton = document.createElement('button');
    copyButton.className = 'copy-code-button';
    copyButton.type = 'button';
    copyButton.setAttribute('aria-label', 'Copy code to clipboard');
    copyButton.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
        <path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/>
      </svg>
      <span class="copy-button-text">Copy</span>
    `;
    
    // Find the appropriate container (pre or .highlight)
    const container = codeBlock.closest('.highlight') || codeBlock.closest('pre');
    if (!container) return;
    
    // Make the container relative for absolute positioning
    container.style.position = 'relative';
    
    // Add the copy button to the container
    container.appendChild(copyButton);
    
    // Add click event listener
    copyButton.addEventListener('click', function() {
      const codeText = codeBlock.textContent || codeBlock.innerText;
      
      // Try to use the modern clipboard API
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(codeText).then(function() {
          showCopySuccess(copyButton);
        }).catch(function() {
          // Fallback to older method
          fallbackCopyToClipboard(codeText, copyButton);
        });
      } else {
        // Fallback for older browsers or non-secure contexts
        fallbackCopyToClipboard(codeText, copyButton);
      }
    });
    
    // Add keyboard event listener
    copyButton.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        copyButton.click();
      }
    });
  });
  
  // Fallback copy method for older browsers
  function fallbackCopyToClipboard(text, button) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showCopySuccess(button);
      } else {
        showCopyError(button);
      }
    } catch (err) {
      showCopyError(button);
    }
    
    document.body.removeChild(textArea);
  }
  
  // Show success feedback
  function showCopySuccess(button) {
    const originalHTML = button.innerHTML;
    button.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
      </svg>
      <span class="copy-button-text">Copied!</span>
    `;
    button.classList.add('copy-success');
    button.setAttribute('aria-label', 'Code copied to clipboard');
    
    setTimeout(function() {
      button.innerHTML = originalHTML;
      button.classList.remove('copy-success');
      button.setAttribute('aria-label', 'Copy code to clipboard');
    }, 2000);
  }
  
  // Show error feedback
  function showCopyError(button) {
    const originalHTML = button.innerHTML;
    button.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
      </svg>
      <span class="copy-button-text">Error</span>
    `;
    button.classList.add('copy-error');
    button.setAttribute('aria-label', 'Failed to copy code');
    
    setTimeout(function() {
      button.innerHTML = originalHTML;
      button.classList.remove('copy-error');
      button.setAttribute('aria-label', 'Copy code to clipboard');
    }, 2000);
  }
});
</script>